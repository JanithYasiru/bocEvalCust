<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Feedback (English)</title>
    <link rel="icon" type="image/png" href="../Admin/Assets/Images/BOC_Logo_16_16_Pixels.jpg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <meta http-equiv="Cache-Control" content="no-store" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="stylesheet" href="../User/styles.css">
</head>

<body>
    <div class="row p-3">
        <div class="col-md-4"></div>
        <div class="col-md-4 text-center">
            <img src="../User/Assets/Images/BOC_Logo_WZ_Rounded.png" class="img-fluid custom-shadow" width="100px"
                height="100px" alt="">
            <h5 class="text-center mb-1 mt-2 text-white">Bank of Ceylon - Monaragala Area</h5>
        </div>
        <div class="col-md-4"></div>
    </div>

    <h3 class="text-center mb-1 mt-2"><strong>Customer Feedback Survey</strong></h3>
    <form id="MainForm">
        <h4 class="text-center mb-4">Please Fill Out the Questions Below</h4>

        <div class="container">
            <!-- Question 1 -->
            <div class="card">
                <div class="card-header">
                    How would you rate the speed of service you received?
                </div>
                <div class="card-body">
                    <select id="Q1" class="form-select">
                        <option value="Excellent">Excellent</option>
                        <option value="Good">Good</option>
                        <option value="Average">Average</option>
                        <option value="Bad">Bad</option>
                        <option value="Poor">Poor</option>
                    </select>
                </div>
            </div>

            <!-- Question 2 -->
            <div class="card">
                <div class="card-header">
                    How satisfied are you with the courtesy and friendliness of our staff?
                </div>
                <div class="card-body">
                    <select id="Q2" class="form-select">
                        <option value="Excellent">Excellent</option>
                        <option value="Good">Good</option>
                        <option value="Average">Average</option>
                        <option value="Bad">Bad</option>
                        <option value="Poor">Poor</option>
                    </select>
                </div>
            </div>

            <!-- Question 3 -->
            <div class="card">
                <div class="card-header">
                    How would you rate the overall cleanliness and ambiance of the branch?
                </div>
                <div class="card-body">
                    <select id="Q3" class="form-select">
                        <option value="Excellent">Excellent</option>
                        <option value="Good">Good</option>
                        <option value="Average">Average</option>
                        <option value="Bad">Bad</option>
                        <option value="Poor">Poor</option>
                    </select>
                </div>
            </div>

            <!-- Question 4 -->
            <div class="card">
                <div class="card-header">
                    How would you rate the efficiency of the bank's services in meeting your needs?
                </div>
                <div class="card-body">
                    <select id="Q4" class="form-select">
                        <option value="Excellent">Excellent</option>
                        <option value="Good">Good</option>
                        <option value="Average">Average</option>
                        <option value="Bad">Bad</option>
                        <option value="Poor">Poor</option>
                    </select>
                </div>
            </div>

            <!-- Question 5 -->
            <div class="card">
                <div class="card-header">
                    How satisfied are you with the clarity and usefulness of the information provided by our staff?
                </div>
                <div class="card-body">
                    <select id="Q5" class="form-select">
                        <option value="Excellent">Excellent</option>
                        <option value="Good">Good</option>
                        <option value="Average">Average</option>
                        <option value="Bad">Bad</option>
                        <option value="Poor">Poor</option>
                    </select>
                </div>
            </div>

            <!-- Question 6 -->
            <div class="card">
                <div class="card-header">
                    How would you rate your satisfaction with our digital banking services (B App, Smart Passbook, Smart
                    Pay, etc.) and other products?
                </div>
                <div class="card-body">
                    <select id="Q6" class="form-select">
                        <option value="Excellent">Excellent</option>
                        <option value="Good">Good</option>
                        <option value="Average">Average</option>
                        <option value="Bad">Bad</option>
                        <option value="Poor">Poor</option>
                    </select>
                </div>
            </div>

            <!-- Suggestion -->
            <div class="card">
                <div class="card-header">
                    Do you have any suggestions for improving our services or products?
                </div>
                <div class="card-body">
                    <textarea id="suggestion" rows="4" class="form-control"></textarea>
                </div>
            </div>

        </div>

        <div class="row p-5 mt-4">
            <div class="col-md-4"></div>
            <div class="col-md-4 text-center">
                <button type="submit" class="btn submit-btn"><i class="fas fa-upload"></i><span
                        class="ms-2"><strong>Submit Feedback</strong></span></button>
            </div>
            <div class="col-md-4"></div>
        </div>
    </form>

    <!-- Modal -->
    <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alertModalLabel">Alert</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="redirectToPage()" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="alertModalBody">
                    <!-- Alert message will be inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        onclick="redirectToPage()">Next</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script>

        function redirectToPage() {
            window.location.href = 'endPage.html';
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getFirestore, doc, updateDoc, increment, writeBatch, setDoc, collection, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC0JLvxC286PUDwjx2oeEkhOMTr_TsYPRg",
            authDomain: "evaluationsysboc.firebaseapp.com",
            projectId: "evaluationsysboc",
            storageBucket: "evaluationsysboc.appspot.com",
            messagingSenderId: "581990176597",
            appId: "1:581990176597:web:2c5dd4ed7df2f3babc01dc",
            measurementId: "G-MZ4TLL0THZ"
        };


        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const form = document.getElementById('MainForm');
        const questions = Array.from({ length: 6 }, (_, i) => document.getElementById(`Q${i + 1}`));
        const suggestion = document.getElementById('suggestion');

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            if (localStorage.getItem('feedbackSubmitted') === 'true') {
                showAlert("You have already submitted your feedback.");
                return;
            }

            const branchCode = JSON.parse(sessionStorage.getItem("branch-num"));

            const batch = writeBatch(db);

            console.log("Submitting feedback...");

            questions.forEach((question, index) => {
                if (question) {
                    const response = question.value;
                    console.log(`Question ${index + 1}: ${response}`);

                    const docRef = doc(db, `Br_in_Area/${branchCode}/Q${index + 1}/responses`);
                    batch.set(docRef, { [response]: increment(1) }, { merge: true });

                } else {
                    console.warn(`Question ${index + 1} element not found or value is undefined.`);
                }
            });

            // Save the suggestion with a unique identifier
            const suggestionText = suggestion.value;
            if (suggestionText.trim()) {
                const suggestionCollectionRef = collection(db, `Br_in_Area/${branchCode}/suggestions`);
                const suggestionCountRef = doc(suggestionCollectionRef, 'count');
                const suggestionCountSnap = await getDoc(suggestionCountRef);

                let suggestionCount = 1;
                if (suggestionCountSnap.exists()) {
                    suggestionCount = suggestionCountSnap.data().count + 1;
                }

                const suggestionId = `suggestion${String(suggestionCount).padStart(2, '0')}`;
                await setDoc(doc(suggestionCollectionRef, suggestionId), { suggestion: suggestionText });
                await setDoc(suggestionCountRef, { count: suggestionCount }, { merge: true });
            }

            // Increment the total response count
            const totalRespCountRef = doc(db, `Br_in_Area/${branchCode}/respCount/totalRespCount`);
            batch.set(totalRespCountRef, { count: increment(1) }, { merge: true });

            try {
                await batch.commit();
                console.log("Feedback S ubmitted successfully!");
                showAlert("Feedback Submitted successfully!");
                localStorage.setItem('feedbackSubmitted', 'true');
                //window.location.href = 'endPage.html';
            } catch (error) {
                console.error("Error submitting feedback:", error);
                showAlert("Failed to submit feedback. Please try again later.");
            }
        });

        function showAlert(message) {
            const alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
            document.getElementById('alertModalBody').innerText = message;
            alertModal.show();
        }




    </script>
</body>

</html>